# ESP32-C3 命令菜单系统使用指南

## 概述

本命令菜单系统为ESP32-C3设备提供了一个通过UART0进行交互的用户界面，可以与系统日志输出共存。用户可以通过串口终端进行WiFi配置和设备管理。

## 系统特性

### ✅ 核心功能
- **共享UART**: 与ESP-IDF日志系统共用UART0端口
- **实时交互**: 支持实时命令输入和响应
- **多级菜单**: 主菜单和WiFi设置子菜单
- **WiFi管理**: 完整的WiFi配置和连接管理
- **设备信息**: 查看设备状态和系统信息

### ✅ 交互特性
- **即时回显**: 输入字符实时显示
- **退格支持**: 支持退格键编辑输入
- **状态提示**: 不同菜单级别显示不同提示符
- **错误处理**: 输入错误时给出明确提示

## 菜单结构

### 一级菜单（主菜单）
```
=== 主菜单 ===
Please choose function:
1. WIFI Setting
2. Help  
3. About
请输入选择: 主菜单>
```

### 二级菜单（WiFi设置）
```
=== WiFi 设置菜单 ===
1. Show Status      - 显示当前WiFi连接状态
2. Scan            - 扫描可用WiFi网络
3. Connect         - 连接到WiFi网络（交互式）
4. Disconnect      - 断开当前WiFi连接
5. List Records    - 列出保存的连接记录
6. Delete Record   - 删除连接记录（交互式）
7. Add Record      - 添加连接记录
0. Exit           - 返回主菜单
请输入选择: WiFi>
```

## 详细功能说明

### 1. WIFI Setting (WiFi设置)

#### 1.1 Show Status (显示状态)
显示当前WiFi连接的详细信息：
- 连接状态（未连接/连接中/已连接）
- SSID和BSSID
- 信号强度（RSSI）
- IP地址、子网掩码、网关、DNS
- 连接时长

示例输出：
```
=== WiFi 状态 ===
连接状态: 已连接
SSID: MyHomeWiFi
BSSID: aa:bb:cc:dd:ee:ff
信号强度: -45 dBm
IP地址: 192.168.1.100
子网掩码: 255.255.255.0
网关: 192.168.1.1
DNS: 8.8.8.8
连接时长: 125 秒
```

#### 1.2 Scan (扫描网络)
扫描并显示周围可用的WiFi网络：
```
=== 扫描 WiFi 网络 ===
正在扫描...
发现 5 个网络:
 1. MyHomeWiFi                   (信号: -42 dBm)
 2. OfficeNetwork               (信号: -58 dBm)
 3. GuestWiFi                   (信号: -65 dBm)
 4. Neighbor_5G                 (信号: -70 dBm)
 5. PublicHotspot              (信号: -75 dBm)
```

#### 1.3 Connect (连接WiFi)
交互式连接到WiFi网络：

**第一步：选择网络**
```
=== 连接 WiFi ===
[显示扫描结果]
请输入要连接的网络序号 (1-5): 连接> 1
```

**第二步：输入密码**
```
选择的网络: MyHomeWiFi
请输入密码 (如果是开放网络请直接按回车): 连接> mypassword123
正在连接到 MyHomeWiFi...
连接成功!
```

#### 1.4 Disconnect (断开连接)
断开当前的WiFi连接：
```
=== 断开 WiFi ===
WiFi已断开
```

#### 1.5 List Records (列出记录)
显示所有保存的WiFi连接记录：
```
=== 连接记录 ===
共有 3 条记录:
 1. MyHomeWiFi                   (序号: 5)
 2. OfficeNetwork               (序号: 3)
 3. GuestWiFi                   (序号: 1)
```

#### 1.6 Delete Record (删除记录)
交互式删除连接记录：
```
=== 删除连接记录 ===
[显示记录列表]
请输入要删除的记录序号 (1-3): 删除> 2
已删除记录: OfficeNetwork
```

#### 1.7 Add Record (添加记录)
```
=== 添加连接记录 ===
此功能将添加一个新的WiFi连接记录
注意：通过 'Connect' 功能连接成功的网络会自动添加记录
提示：请使用 'Connect' 功能连接WiFi，成功后会自动添加记录
```

### 2. Help (帮助)
显示详细的使用帮助信息：
- 功能说明
- 操作提示  
- 注意事项

### 3. About (关于)
显示设备信息：
- 设备型号和序列号
- 固件版本和编译时间
- 功能简介和技术规格
- 开发信息

## 使用方法

### 基本操作
1. **启动菜单**: 设备启动后，按回车键显示主菜单
2. **选择功能**: 输入数字选择相应功能
3. **编辑输入**: 支持退格键编辑，回车确认
4. **返回上级**: 在WiFi菜单中输入0返回主菜单

### 连接WiFi的完整流程
1. 按回车显示主菜单
2. 输入 `1` 进入WiFi设置
3. 输入 `3` 选择Connect
4. 查看扫描结果，输入网络序号
5. 输入WiFi密码
6. 等待连接结果

### 管理保存的网络
1. 使用 `5` 查看已保存的网络
2. 使用 `6` 删除不需要的网络
3. 通过连接新网络自动添加记录

## 集成到现有项目

### 1. 添加文件
将以下文件添加到main目录：
- `command_menu.h` - 头文件
- `command_menu.c` - 实现文件

### 2. 更新CMakeLists.txt
```cmake
idf_component_register(SRCS "your_files.c" "command_menu.c"
                    INCLUDE_DIRS "."
                    REQUIRES driver wifi_station ...)
```

### 3. 在app_main中初始化
```c
#include "command_menu.h"
#include "wifi_station.h"

void app_main(void)
{
    // 基础初始化...
    nvs_flash_init();
    esp_netif_init();
    esp_event_loop_create_default();
    
    // 初始化WiFi组件
    wifi_station_init();
    
    // 初始化命令菜单
    command_menu_init();
    command_menu_start();
    
    // 您的应用代码...
}
```

## 技术细节

### UART配置
- **端口**: UART0 (与日志共用)
- **波特率**: 115200
- **数据位**: 8位
- **停止位**: 1位
- **校验**: 无
- **缓冲区**: 1024字节收发缓冲

### 任务参数
- **任务名**: "command_menu"
- **栈大小**: 4096字节
- **优先级**: 5
- **核心**: 任意

### 内存使用
- **RAM**: 约2KB（包括缓冲区）
- **任务栈**: 4KB
- **总计**: 约6KB

## 注意事项

### ⚠️ 使用限制
1. **输入长度**: 最大127字符
2. **扫描结果**: 最多显示30个网络
3. **记录数量**: 最多保存8个WiFi记录
4. **连接超时**: 15秒连接超时

### ⚠️ 兼容性
1. **日志交错**: 菜单输出可能与系统日志交错
2. **UART冲突**: 避免其他组件使用UART0
3. **中断安全**: 不要在中断中调用菜单API

### ⚠️ 安全考虑
1. **密码存储**: WiFi密码明文保存在NVS中
2. **串口安全**: 串口输入可能被监听
3. **权限控制**: 任何人都可以通过串口配置设备

## 故障排除

### 常见问题

**Q: 按回车没有显示菜单**
A: 检查UART驱动是否正确安装，确认波特率设置

**Q: 输入字符没有回显**
A: 检查串口终端的本地回显设置

**Q: WiFi扫描失败**
A: 确认WiFi组件已正确初始化，检查天线连接

**Q: 连接记录丢失**
A: 检查NVS分区是否有足够空间，确认NVS初始化成功

**Q: 菜单响应慢**
A: 检查系统负载，适当调整任务优先级

### 调试方法
1. 启用详细日志: `idf.py menuconfig` → Component config → Log output
2. 检查任务状态: 使用 `vTaskList()` 查看任务运行状态
3. 监控内存使用: 使用 `esp_get_free_heap_size()` 检查内存
4. 串口工具: 使用支持本地回显的终端工具

## 扩展和定制

### 添加新菜单项
1. 在菜单显示函数中添加选项
2. 在命令处理函数中添加case
3. 实现具体的功能函数

### 修改界面样式
1. 调整菜单显示格式
2. 修改提示符样式
3. 自定义输出颜色（如果终端支持）

### 增强安全性
1. 添加密码验证
2. 实现访问控制
3. 加密敏感信息存储

这个命令菜单系统为您的ESP32-C3设备提供了强大而灵活的用户交互界面，便于设备配置和管理！ 